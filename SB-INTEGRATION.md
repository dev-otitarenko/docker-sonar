# Integration Spring Boot Application Source Code with Sonarqube

While our software projects evolve, they must be in good quality. Thus, we apply practices like TDD and pair programming.
Besides, we can benefit from quality measurement tools like Sonarqube. Above all, in this post, we are going to check out 
how we can configure Spring boot 2.x.x with Sonarqube.

## Tools

Below components are used for the sample project:
1. [Spring Boot 2.x.x](https://start.spring.io/)
2. [Sonarqube (community edition)](https://www.sonarqube.org/)
3. [sonar-maven-plugin 3.9.0.2155](https://mvnrepository.com/artifact/org.sonarsource.scanner.maven/sonar-maven-plugin)
4. [maven-surefire-plugin 3.0.0-M5](https://mvnrepository.com/artifact/org.apache.maven.plugins/maven-surefire-plugin)
5. [jacoco-maven-plugin 0.8.7](https://mvnrepository.com/artifact/org.jacoco/jacoco-maven-plugin)

## Maven Plugin Details

Before starting the example, let’s learn what are these plugins for.

### Sonar Maven Plugin

This plugin provides a Sonar Scanner for Maven. When we run the plugin’s goal with "sonar:sonar", the code quality 
measurement processes locally and sends the report to the configured Sonarqube server.

### Maven Surefire Plugin

This plugin is special for maven. Even though you don’t include it into the project, when you run the tests with maven 
it will download and run the tests with this plugin. Also, you can specify running order, test class name patterns 
to include, etc... After running the tests, the Surefire plugin generates reports like below:

### Jacoco Maven Plugin

Jacoco plugin is used to calculate the test coverage ratio. With the latest version of Sonarqube, the coverage is 
only generated via this plugin. Thus, you cannot get the coverage info without Jacoco anymore.

## Configuring the pom.xml

Now the most important part, configuring the pom.xml.
Adding the sonar-maven-plugin is very straightforward:

```
<plugin>
  <groupId>org.sonarsource.scanner.maven</groupId>
  <artifactId>sonar-maven-plugin</artifactId>
  <version>3.7.0.1746</version>
</plugin>
```

Next, the most important part #1. To be able to pass the jacoco measurement result to the surefire plugin correctly, 
we should set `propertyName` in the pre-agent configuration stanza.

```
<plugin>
  <groupId>org.jacoco</groupId>
  <artifactId>jacoco-maven-plugin</artifactId>
  <version>0.8.5</version>
  <executions>
    <execution>
      <id>pre-test</id>
      <goals>
        <goal>prepare-agent</goal>
      </goals>
      <configuration>
        <propertyName>jacocoArgLine</propertyName>
        <destFile>${project.test.result.directory}/jacoco/jacoco.exec</destFile>
      </configuration>
    </execution>
    <execution>
      <id>post-test</id>
      <phase>test</phase>
      <goals>
        <goal>report</goal>
      </goals>
      <configuration>
        <dataFile>${project.test.result.directory}/jacoco/jacoco.exec</dataFile>
        <outputDirectory>${project.test.result.directory}/jacoco</outputDirectory>
      </configuration>
    </execution>
  </executions>
</plugin>
```

As you can see above, there are two execution phases configured.

### Pre Agent

In the pre-agent configuration, the report file destination path is configured and passed to a property for 
the surefire plugin.

### Report

This execution configures the report creation. Thus, the data file and output directory are configured here. 
Above all, this configuration ensures that the coverage report for unit tests created after unit tests have been run.
The next most important part is to configure the surefire plugin.

```
<plugin>
  <groupId>org.apache.maven.plugins</groupId>
  <artifactId>maven-surefire-plugin</artifactId>
  <version>3.0.0-M4</version>
  <configuration>
    <argLine>${jacocoArgLine}</argLine>
    <reportsDirectory>${project.test.result.directory}/surefire</reportsDirectory>
  </configuration>
</plugin>
```

There are only two configurations here.

### Arg-Line

Arg line section is the configuration where we pass the jacoco `propertyName` so that the surefire plugin can process 
the report generated by the jacoco plugin.

### Reports Directory

Reports directory configures the path where the surefire reports will be created.
Last but not least, we should add Sonar properties.

```
<project.test.result.directory>${project.build.directory}/test-results</project.test.result.directory>
<sonar.host.url>http://localhost:9000</sonar.host.url>
<sonar.login>...</sonar.login>
<sonar.password>...</sonar.password>
<sonar.scm.provider>git</sonar.scm.provider>
<sonar.java.codeCoveragePlugin>jacoco</sonar.java.codeCoveragePlugin>
<sonar.coverage.jacoco.xmlReportPaths>${project.test.result.directory}/jacoco/jacoco.xml</sonar.coverage.jacoco.xmlReportPaths>
<sonar.exclusions>
  **/*.xml
</sonar.exclusions>
<sonar.coverage.exclusions>
  **/qualitymeasurementsample/*
</sonar.coverage.exclusions>
```

To explain each:
<b>project.test.result.directory</b>: This is a custom property that we add to be able to easily manage the test result directory value.
<b>sonar.host.url</b>: The sonar server URL.
<b>sonar.scm.provider</b>: With the latest version of Sonarqube, it suggests passing the SCM provider value.
<b>sonar.java.codeCoveragePlugin</b>: Sets the coverage plugin name.
<b>sonar.coverage.jacoco.xmlReportPaths</b>: With the latest version of Sonarqube, the coverage report is processed via 
the Jacoco XML report. Previously it was able to use CSV reports.
<b>sonar.exclusions</b>: To be able to exclude any unrelated folder or file types.
<b>sonar.coverage.exclusions</b>: This provides us to exclude any code file unrelated to the coverage report. 
For example Spring Boot Main class.
You can find more configuration keys in the Sonarqube server Administration -> Configuration -> Analysis Scope.

#### Sonar Configuration Wildcards

Sonar wildcards are explained below.
* -> Match zero or more characters. This is used to define generic class names or all.
  ** -> Match zero or more directories. This is used to ignore sub packaging.
  ? -> Match a single character

## Running the Analysis

The above configurations and codes complete the sample project. Now we can simply type below command
in the root directory of the project.

```sh
mvn clean install sonar:sonar
```

This command will run all the tests and generate the report on the Sonarqube server. 